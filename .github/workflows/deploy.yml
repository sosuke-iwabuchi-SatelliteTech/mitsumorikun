name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Release Name
        run: echo "RELEASE_NAME=$(TZ='Asia/Tokyo' date +'%Y%m%d%H%M%S')-${{ github.run_id }}" >> $GITHUB_ENV

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, json
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction
          npm ci

      - name: Build frontend
        run: npm run build

      - name: Create Release Artifact
        run: |
          mkdir -p deploy/database deploy/public
          # ソースコードをコピー (SQLiteファイルは含めない)
          # langディレクトリを追加、不要なtextbookを削除
          cp -r app bootstrap config lang resources routes vendor artisan composer.json composer.lock vite.config.ts package.json deploy/
          cp -r database/migrations database/seeders deploy/database/
          
          # public配下のコピー
          cp -r public/build deploy/public/
          [ -d public/images ] && cp -r public/images deploy/public/ || true
          
          # public直下のファイルをコピー
          cp public/index.php public/.htaccess deploy/public/
          cp public/*.ico public/*.txt public/*.webmanifest public/*.json deploy/public/ 2>/dev/null || true
          cp public/*.png public/*.svg deploy/public/ 2>/dev/null || true
          
          # storageの枠組みだけ作成（リンク用）
          mkdir -p deploy/storage
          
          tar -czf release.tar.gz -C deploy .

      - name: Upload Artifact
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "release.tar.gz"
          target: ${{ secrets.APP_ROUTE_PATH }}/releases/${{ env.RELEASE_NAME }}

      - name: Deploy and Link
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            APP_PATH=${{ secrets.APP_ROUTE_PATH }}
            RELEASE_PATH=$APP_PATH/releases/${{ env.RELEASE_NAME }}
            SHARED_PATH=$APP_PATH/shared

            # 1. 永続ディレクトリ・共有ファイルの準備 (初回のみ)
            mkdir -p $SHARED_PATH/storage/app/public $SHARED_PATH/storage/framework/cache $SHARED_PATH/storage/framework/sessions $SHARED_PATH/storage/framework/views $SHARED_PATH/storage/logs
            mkdir -p $SHARED_PATH/database
            [ -f $SHARED_PATH/database/database.sqlite ] || touch $SHARED_PATH/database/database.sqlite
            
            # 2. リリースの展開
            cd $RELEASE_PATH
            tar -xzf release.tar.gz
            rm release.tar.gz

            # 3. 共有アイテムへのシンボリックリンク
            # .env
            ln -nfs $APP_PATH/.env $RELEASE_PATH/.env
            
            # storage (リンクを貼る前にartifactの空ディレクトリを削除)
            rm -rf $RELEASE_PATH/storage
            ln -nfs $SHARED_PATH/storage $RELEASE_PATH/storage
            
            # database.sqlite
            ln -nfs $SHARED_PATH/database/database.sqlite $RELEASE_PATH/database/database.sqlite

            # 4. 権限とグループの整合性
            # 新しいリリースのグループを www-data に変更
            chgrp -R www-data $RELEASE_PATH
            # ディレクトリに SGID を設定 (既存のディレクトリ構成に合わせる)
            find $RELEASE_PATH -type d -exec chmod g+s {} +
            # storage と database への書き込み権限
            chmod -R 775 $SHARED_PATH/storage $SHARED_PATH/database

            # 5. Laravel最適化とマイグレーション
            php artisan optimize:clear
            php artisan migrate --force
            php artisan storage:link
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # 5. 公開ディレクトリの切り替え (Atomic Switch)
            ln -nfs $RELEASE_PATH $APP_PATH/current

            # 6. 古いリリースの削除 (最新5世代を残す)
            cd $APP_PATH/releases
            ls -1t | tail -n +6 | xargs rm -rf 2>/dev/null || true
