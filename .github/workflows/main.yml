name: Deploy Production

on:
  # 手動実行のみをトリガーに設定
  workflow_dispatch:

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, json
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Install NPM dependencies
        run: npm ci

      - name: Build
        env:
          VITE_GACHA_IMAGE_HOST: ${{ secrets.VITE_GACHA_IMAGE_HOST }}
        run: npm run build

      - name: Create Deployment Artifact
        run: |
          mkdir -p deploy/database deploy/public
          cp -r app bootstrap config resources routes vendor deploy/
          cp -r database/migrations database/seeders database/factories deploy/database/
          cp -r public/build public/textbook deploy/public/
          cp public/index.php public/.htaccess deploy/public/
          cp public/*.png public/*.svg public/*.ico public/*.json public/*.txt deploy/public/ 2>/dev/null || true
          cp artisan composer.json composer.lock vite.config.js package.json deploy/
          tar -czf release.tar.gz -C deploy .

      - name: Deploy via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "release.tar.gz"
          target: ${{ secrets.APP_ROUTE_PATH }}

      - name: Execute remote commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd ${{ secrets.APP_ROUTE_PATH }}
            php artisan down || true
            tar -xzf release.tar.gz
            rm release.tar.gz
            chmod -R 775 storage bootstrap/cache database
            php artisan optimize:clear
            php artisan migrate --force
            php artisan db:seed --force
            php artisan storage:link
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan up
